# Мониторинг и обеспечение постоянной работы сервиса

## Текущая конфигурация

Сервис `g2g-scraper` настроен для постоянной работы на хостинге с использованием systemd.

### Автоматический запуск при загрузке системы

Сервис включен для автозапуска:
```bash
systemctl is-enabled g2g-scraper.service
# Должно вернуть: enabled
```

### Автоматический перезапуск при сбоях

Сервис настроен на автоматический перезапуск при любых сбоях:
- `Restart=always` - перезапуск всегда
- `RestartSec=10` - задержка 10 секунд перед перезапуском
- `StartLimitInterval=300` - окно для подсчета попыток запуска (5 минут)
- `StartLimitBurst=5` - максимум 5 попыток запуска в окне

### Мониторинг через скрипт

Установлен скрипт мониторинга `/opt/g2g-scraper/monitor-service.sh`, который:
- Проверяет статус сервиса каждые 5 минут (через crontab)
- Автоматически запускает сервис, если он остановлен
- Проверяет HTTP доступность сервиса
- Перезапускает сервис, если он не отвечает на запросы
- Логирует все действия в `/opt/g2g-scraper/logs/monitor.log`

## Команды для управления

### Проверка статуса
```bash
systemctl status g2g-scraper.service
```

### Ручной перезапуск
```bash
systemctl restart g2g-scraper.service
```

### Просмотр логов
```bash
# Логи systemd
journalctl -u g2g-scraper.service -f

# Логи приложения
tail -f /opt/g2g-scraper/logs/activity.log

# Логи мониторинга
tail -f /opt/g2g-scraper/logs/monitor.log
```

### Проверка автозапуска
```bash
systemctl is-enabled g2g-scraper.service
```

### Включение автозапуска (если отключен)
```bash
systemctl enable g2g-scraper.service
```

## Автоматическое сканирование

Сервис автоматически:
- Сканирует заказы каждые 2 минуты
- Синхронизирует данные с Trello
- Проверяет соответствие данных с G2G
- Обновляет карточки при расхождениях

Настройки можно изменить через переменные окружения в `.env`:
- `SCAN_INTERVAL_MINUTES=2` - интервал сканирования
- `AUTO_SCAN_ENABLED=true` - включить/выключить автозапуск
- `VERIFY_WITH_G2G=true` - включить/выключить проверку соответствия

## Устранение неполадок

### Сервис не запускается
1. Проверьте логи: `journalctl -u g2g-scraper.service -n 50`
2. Проверьте конфигурацию: `systemctl cat g2g-scraper.service`
3. Проверьте права доступа к файлам: `ls -la /opt/g2g-scraper`

### Сервис падает
1. Проверьте логи на ошибки
2. Проверьте использование памяти: `systemctl status g2g-scraper.service`
3. Проверьте доступность G2G и Trello API

### Ручной запуск скрипта мониторинга
```bash
/opt/g2g-scraper/monitor-service.sh
```

## Тестирование автоперезапуска

Для проверки, что автоперезапуск работает:
```bash
# Останавливаем сервис
systemctl stop g2g-scraper.service

# Ждем 15 секунд
sleep 15

# Проверяем, что сервис перезапустился
systemctl status g2g-scraper.service
```

Сервис должен автоматически перезапуститься через 10 секунд.

